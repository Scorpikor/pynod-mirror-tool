# Default server configuration

map $http_user_agent $ver {
    "~^.*(EEA|EES|EFSW|EMSX|ESFW)+\s+Update.*BPC\s+(\d+)\..*$" "ep$2";
    "~^.*Update.*BPC\s+(\d+)\..*$" "v$1";
}

server {
    listen [::]:80;
    listen 80;
    listen 443 ssl;
    listen [::]:443 ssl;
    server_name eset.****.ru;

    ssl_certificate /etc/ssl/certs/eset.****.ru-crt.pem;  # Путь к сертификату
    ssl_certificate_key /etc/ssl/private/eset.****.ru-key.pem;  # Путь к ключу

     # Дополнительные настройки SSL (рекомендуется для безопасности)
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # Установка переменной root_path
    set $root_path /var/www/nod32mirror;

    index index.html;

    # Доп. заголовки
    add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
    add_header Cache-Control "no-cache, public, must-revalidate";
    real_ip_header X-Real-IP;
    real_ip_recursive on;

    # Добавляем авторизацию для доступа ко всему сайту
    auth_basic "Restricted Access";  # Сообщение, которое будет показываться при запросе пароля
    auth_basic_user_file /etc/nginx/.htpasswd;  # Путь к файлу с паролями

    # Установка root для сервера

    location = /index.html {
        root $root_path;
        try_files $uri =404;
    }

    # Логика для update.ver
    location ~* \.ver$ {
        if ($ver ~ "^ep[6-9]$") { rewrite ^/(dll/)?update.ver$ /eset_upd/$ver/$1update.ver break; }
        if ($ver ~ "^ep1[0-9]$") { rewrite ^/(dll/)?update.ver$ /eset_upd/$ver/$1update.ver break; }
        if ($ver ~ "^v[3-8]$")   { rewrite ^(.*) /eset_upd/v3/dll/update.ver break; }
        if ($ver ~ "^v1[0-1]$")  { rewrite ^(.*) /eset_upd/v10/dll/update.ver break; }
        if ($ver ~ "^v1[2-9]$")  { rewrite ^(.*) /eset_upd/$ver/dll/update.ver break; }
    }

    # Логика для "остальных файлов"
    location / {
        set $ver_path $ver;

        if ($ver ~ "^v[3-8]$") {
            set $ver_path v3;
        }
        if ($ver ~ "^v1[0-1]$") {
            set $ver_path v10;
        }

        root $root_path/data/$ver_path;
        try_files $uri $uri/ =404;
    }

    # Лог файлы
    access_log /var/log/nginx/access_nod32mirror.log;
    error_log /var/log/nginx/error_nod32mirror.log;
}