# ------------------------------------------------------------
# Определяем версию продукта по User-Agent
# ------------------------------------------------------------
map $http_user_agent $ver {
    # Продукты EEA, EES, EFSW, EMSX, ESFW
    "~^.*(EEA|EES|EFSW|EMSX|ESFW)\s+Update.*BPC\s+(\d+)(\..*)?$"  ep$2;

    # Все остальные продукты
    "~^.*Update.*BPC\s+(\d+)(\..*)?$"                            v$1;
}

# ------------------------------------------------------------
# Нормализация путей для старых версий
# ------------------------------------------------------------
map $ver $ver_path {
    ~^v[3-8]$   v3;
    ~^v1[0-1]$  v10;
    default     $ver;
}

# ============================================================
# Основной сервер: домен **************
# ============================================================
server {
    listen 80;
    
#   listen 443 ssl; # включить https
#   listen [::]:443 ssl; # включить https ipv6
    
    server_name ***********;

# Пусть к SSL серту
    #ssl_certificate /etc/letsencrypt/live/******/fullchain.pem; # managed by Certbot
# Путь к сертификату
    #ssl_certificate_key /etc/letsencrypt/live/*****/privkey.pem; # managed by Certbot
# Путь к ключу

# Дополнительные настройки SSL усиленные, для версий от 10 и выше
    #ssl_protocols TLSv1.2 TLSv1.3;
    #ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256';
    #ssl_prefer_server_ciphers off;
    #ssl_session_cache shared:SSL:10m;
    #ssl_session_timeout 10m;
# Лайтовые настройки SSL, т.к. версии ниже 10й не понимаю то что выше.
    #ssl_protocols TLSv1 TLSv1.1 TLSv1.2 TLSv1.3;
    #ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA:ECDHE-RSA-AES256-SHA:DHE-RSA-AES256-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES128-SHA:DHE-RSA-AES128-SHA';
    #ssl_prefer_server_ciphers off;
    #ssl_session_cache shared:SSL:10m;
    #ssl_session_timeout 10m;

    # Базовый root. Меняется под свой путь.
    set $root_path /var/www/nod32mirror;
    index index.html;

    # --------------------------------------------------------
    # Заголовки
    # --------------------------------------------------------
    add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
    add_header Cache-Control "no-cache, public, must-revalidate";

    real_ip_header X-Real-IP;
    real_ip_recursive on;

    # --------------------------------------------------------
    # Главная страница
    # --------------------------------------------------------
    location = / {
        root  $root_path;
        index index.html;
    }

    location = /index.html {
        root      $root_path;
        try_files $uri =404;
    }

    # --------------------------------------------------------
    # update.ver
    # --------------------------------------------------------
    location ~* \.ver$ {
    
        # HTTP Basic Auth ТОЛЬКО для update.ver
        auth_basic           "ESET Update Access";  # Сообщение, которое будет показываться при запросе пароля
        auth_basic_user_file /etc/nginx/.htpasswd;  # # Путь к файлу с паролями

        # Блокируем мусор и загрузчики
        if ($http_user_agent ~* ^(wget|aria2|nod32view|perl|php|curl|google|yandex|yahoo|-|mirror|spider|bot|parser|grab)) {
            return 403;
        }

        root /var/www/nod32mirror;

        if ($ver ~ "^ep[6-9]$")  { rewrite ^/(dll/)?update\.ver$ /eset_upd/$ver/$1update.ver break; }
        if ($ver ~ "^ep1[0-9]$") { rewrite ^/(dll/)?update\.ver$ /eset_upd/$ver/$1update.ver break; }
        if ($ver ~ "^v[3-8]$")   { rewrite ^.*$ /eset_upd/v3/dll/update.ver break; }
        if ($ver ~ "^v1[0-1]$")  { rewrite ^.*$ /eset_upd/v10/dll/update.ver break; }
        if ($ver ~ "^v1[2-9]$")  { rewrite ^.*$ /eset_upd/$ver/dll/update.ver break; }
    }

    # --------------------------------------------------------
    # Остальные файлы обновлений
    # --------------------------------------------------------
    location / {
        root      $root_path/data/$ver_path;
        try_files $uri $uri/ =404;
    }

    # --------------------------------------------------------
    # Логи
    # --------------------------------------------------------
    access_log /var/log/nginx/access_nod32mirror.log;
    #error_log /var/log/nginx/error_nod32mirror.log debug;
    error_log  /var/log/nginx/error_nod32mirror.log;
}

# ============================================================
# Сервер для доступа по IP
# ============================================================
server {
    listen 80;
    server_name _;

    root  /var/www/nod32mirror;
    index index.html;

    location / {
        try_files $uri $uri/ =404;
    }
}